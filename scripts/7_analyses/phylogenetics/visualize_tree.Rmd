# Visualize Phylogenetic Tree with Metadata

```{r}
library(ggplot2)
library(ggtree)
library(readxl)
library(dplyr)
library(tidyr)
library(stringr)
```
## 164 Taxa Tree

### Load Data

```{r}
tree <- ape::read.nexus("tree0.tnt.nex")
metadata <- read_excel("../../../Experiments.xlsx", sheet = "Antigens")
results <- read_excel("../../../Experiments.xlsx", sheet = "Experiments")
```


## Append Metadata

```{r}
tip_meta <- tip_labels %>%
  left_join(metadata, by = "antigen_id")

tree_df <- data.frame(node = 1:length(tree$tip.label),
                      tip_label = tree$tip.label) %>% 
  left_join(metadata, by = c("tip_label" = "antigen_id"))

tree$antigen_host_order <- tree_df$antigen_host_order 
```

### Make VDW Results Matrix

```{r}
# genotype_file <- system.file("examples/Genotype.txt", package="ggtree")
# genotype <- read.table(genotype_file, sep="\t", stringsAsFactor=F)
# colnames(genotype) <- sub("\\.$", "", colnames(genotype))
# 
# genotype

vdw_df <- results %>% 
  select(antibody_id, antigen_id, vdw_best) %>% 
  pivot_wider(names_from = antibody_id, values_from = vdw_best) %>% 
  tibble::column_to_rownames(var="antigen_id") %>% 
  select(order(colnames(.)))

vdw_df

```




### Visualize the Base Tree

```{r}
base_tree_plot <- ggtree(tree,
                         # layout="circular", 
                         layout="fan", open.angle=30,
                         # ladderize = FALSE,
                         # branch.length = "none",
                         # continuous = 'colour',
                         size=1
                         ) %<+% 
    metadata +
  geom_tiplab(size=2, align=TRUE, linesize=.5) # +
  # geom_text(aes(label=node), hjust=.3) +
  # aes(color=antigen_collection_location_continent) + 
  # scale_color_gradient(colours=c("red", 'orange', 'green', 'cyan', 'blue')) +
  # geom_tippoint(aes(color=antigen_host_order)) +
  # coord_flip() +
  # scale_x_reverse() #+
  # theme(color = "Host Order"
  #       shape = "Representative Sequence")
  # geom_tiplab(hjust = -.1)
  # theme(legend.position = "none")


base_tree_plot
```


## Add Heatmap to Tree

```{r}

gheatmap(base_tree_plot,
         vdw_df,
         offset=8, width=1, 
        colnames=TRUE,
        colnames_angle = 90,
        hjust = 1,
        font.size = 3,
        legend_title="Best van der Waals Energy") +
    scale_x_ggtree() +
  scale_fill_viridis_c(option = "plasma")
```
