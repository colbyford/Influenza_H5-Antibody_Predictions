# Make Statistics and Figures

```{r}
## Tidyverse Stuff
library(dplyr)
library(tidyr)
library(forcats)
library(readxl)

## Plotting Libraries
library(ggplot2)
library(ggpubr)
library(ggExtra)
library(ggdendroplot)
library(ggsci)

alpha = 0.05
```

## Load in Data

```{r}
experiments <- read_excel("../../Experiments.xlsx", sheet = "Experiments")
antibodies <- read_excel("../../Experiments.xlsx", sheet = "Antibodies")
antigens <- read_excel("../../Experiments.xlsx", sheet = "Antigens")

## Exclude lab-derived isolates
exclusions <- c("EPI243001", "EPI287236", "EPI359214")

data <- experiments %>% 
  left_join(antibodies, by="antibody_id") %>% 
  left_join(antigens, by="antigen_id") %>% 
  filter(!antigen_id %in% exclusions)
```

## Define UNCC Color Palette
```{r}
uncc_colors <- c(
  ## All in C colors
  "#005035", ## Charlotte Green
  "#A49665", ## Niner Gold
  "#F1E6B2", ## Jasper
  "#899064", ## Pine Green
  "#802F2D", ## Clay Red
  "#007377",  ## Sky Blue
  
  ## Others
  "#717C7D", ## 444C (Grey)
  "#72246C", ## 255C (Purple)
  "#006BA6", ## 307C (Blue)
  "#DF4661", ## 198C
  "#FFB81C", ## 1235C
  "#696158"  ## 405C
  
)
```

## Create Boxplots

### Antibody Performance

#### Setup Comparisons to Perform

```{r}
## Create Boxplots of metrics by Fv type
plot_comparisons <- combn(unique(data$antibody_id), 2, simplify = FALSE)

## perform wilcox test on plot_comparisons
wilcox_results <- lapply(plot_comparisons, function(x) {
  wilcox.test(data %>% 
                filter(antibody_id %in% x) %>% 
                pull(vdw_mean) ~ data %>% 
                filter(antibody_id %in% x) %>% 
                pull(antibody_id))
})

## Filter to significant
sig_plot_comparisons <- plot_comparisons[sapply(wilcox_results,
                                                function(x) x$p.value < alpha)]
```

#### General Plot Function

```{r}
make_h5_boxplot_by_antibody <- function(y, y_lab){
  plot <- ggplot(data, 
                 aes_string(
                   x = "antibody_id",
                   y = y,
                   fill = "antibody_id"
                 )) + 
    geom_violin() +
    geom_boxplot(width=0.25, fill = "white", color = "black", outlier.size = 2, notch = TRUE) +
    stat_compare_means() +
    labs(y = y_lab,
         x = 'Antibody',
         color = "Antibody") +
    scale_fill_manual(values = uncc_colors) +
    theme_linedraw() +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
          line = element_line(colour = "grey"),
          axis.line = element_line(color = "grey"),
          panel.grid.minor = element_blank(),
          panel.grid.major = element_line(color = "grey"),
          legend.position = "none"
    )
  
  return(plot)
}
```

```{r}
## van der Waals Energy
boxplot_vdw_by_antibody <- make_h5_boxplot_by_antibody(y = "vdw_mean", y_lab = "Mean van der Waals Energy" )

## Electrostatic Energy
boxplot_elec_by_antibody <- make_h5_boxplot_by_antibody(y = "elec_mean", y_lab = "Mean Electrostatic Energy")

## Desolvation Energy
boxplot_desolv_by_antibody <- make_h5_boxplot_by_antibody(y = "desolv_mean", y_lab = "Mean Desolvation Energy")

## Buried Surface Area
boxplot_bsa_by_antibody <- make_h5_boxplot_by_antibody(y = "bsa_mean", y_lab = "Mean Buried Surface Area")

## HADDOCK Score
boxplot_haddock_by_antibody <- make_h5_boxplot_by_antibody(y = "haddock_score_mean", y_lab = "Mean HADDOCK Score")

## Total Score
boxplot_total_by_antibody <- make_h5_boxplot_by_antibody(y = "total_mean", y_lab = "Mean Total Energy")
```

#### Place on single plot

```{r}
boxplots_by_antibody_grid = ggarrange(boxplot_vdw_by_antibody,
                                 boxplot_elec_by_antibody,
                                 boxplot_desolv_by_antibody,
                                 boxplot_bsa_by_antibody,
                                 boxplot_haddock_by_antibody,
                                 boxplot_total_by_antibody,
                                 labels = c("A.", "B.", "C.", "D.", "E.", "F."),
                                 ncol = 2, nrow = 3)

# boxplots_by_antibody_grid
```

```{r}
ggsave("../../figures/boxplots_by_antibody_grid.pdf", width = 16.5, height = 12.75, units = "in")
```


### Comparisons with Mutations


```{r}
make_mutation_boxplot <- function(x, y, x_lab, y_lab, ref_aa){
  
  ## Get mutations and put ref_aa first
  mutations <- unique(data[[x]])
  mutations <- c(ref_aa, mutations[!mutations %in% ref_aa])
  
  ## Create Boxplots of metrics by Fv type
  mut_plot_comparisons <- combn(mutations, 2, simplify = FALSE)

  ## Perform wilcox test on comparisons
  mut_wilcox_results <- lapply(mut_plot_comparisons, function(z) {
    wilcox.test(data %>% 
                  filter(.data[[x]] %in% z) %>% 
                  pull(.data[[y]]) ~ data %>% 
                  filter(.data[[x]] %in% z) %>% 
                  pull(.data[[x]]))
  })
  
  ## Filter to significant
  sig_mut_plot_comparisons <- mut_plot_comparisons[sapply(mut_wilcox_results,
                                                  function(x) x$p.value < alpha)] 
  
  ## Reorder x column in data using mutations
  plot <- ggplot(data %>% 
                   mutate(!!x := fct_relevel(.data[[x]], mutations),
                          is_ref = .data[[x]] == ref_aa), 
                   aes_string(
                     ## reorder to put "N" first
                     x = x,
                     y = y,
                     fill = "is_ref"
                   )) + 
      geom_violin() +
      geom_boxplot(width=0.25, fill = "white", color = "black", outlier.size = 2, notch = FALSE) +
      stat_compare_means(method = "wilcox.test", comparisons = sig_mut_plot_comparisons) +
      labs(y = y_lab,
           x = x_lab,
           color = "Antibody") +
      scale_fill_manual(values = uncc_colors) +
      theme_linedraw() +
      theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
            line = element_line(colour = "grey"),
            axis.line = element_line(color = "grey"),
            panel.grid.minor = element_blank(),
            panel.grid.major = element_line(color = "grey"),
            legend.position = "none"
      )

  return(plot)
}
```

```{r}
y = "vdw_mean"
y_lab = "Mean van der Waals Energy"

x = "aa_4jug_pos_224"
x_lab = "N224 Mutation"

make_mutation_boxplot(x, y, x_lab, y_lab, ref_aa = "N")
```

```{r}
metrics_cols <- list(c("Mean van der Waals Energy", "vdw_mean"),
                     c("Mean Electrostatic Energy", "elec_mean"),
                     c("Mean Desolvation Energy", "desolv_mean"),
                     c("Mean Buried Surface Area"= "bsa_mean"),
                     c("Mean HADDOCK Score", "haddock_score_mean"),
                     c("Mean Total Score", "total_mean"))

mutations_cols <- list(c("N158 Mutation", "aa_4jug_pos_158"),
                      c("T160 Mutation", "aa_4jug_pos_160"),
                      c("E190 Mutation", "aa_4jug_pos_190"),
                      c("N224 Mutation", "aa_4jug_pos_224"),
                      c("G225 Mutation", "aa_4jug_pos_225"),
                      c("Q226 Mutation", "aa_4jug_pos_226"),
                      c("G228 Mutation", "aa_4jug_pos_228"))

mutation_plots <- list()
## Make plot for each combination
for (metric in metrics_cols){
  for (mut in mutations_cols){
    # print(metric)
    # print(mut)
    x = metric[2]
    x_lab = metric[1]
    y = mut[2]
    y_lab = mut[1]
    ref_aa = substr(y_lab,1,1)
    plot <- make_mutation_boxplot(x, y, x_lab, y_lab, ref_aa)
    mutation_plots[[paste0(x, "_", y)]] <- plot
  }
}

# mutation_plots_grid <- ggarrange(plotlist = mutation_plots, ncol = 6)
# mutation_plots_grid
```

## Heatmaps

### VDW Energy

#### Build Clusters

```{r}
## Source: https://github.com/NicolasH2/ggdendroplot

## Make pivoted data.frame by antigen/antibody for VDW energy
data_vdw_pivot <- data %>% 
  select(antigen_id, antibody_id, vdw_mean) %>% 
  pivot_wider(names_from = antibody_id, values_from = vdw_mean)

data_vdw_pivot_mat <- data_vdw_pivot %>% select(-antigen_id)%>% as.matrix()
rownames(data_vdw_pivot_mat) <- data_vdw_pivot$antigen_id
colnames(data_vdw_pivot_mat) <- colnames(data_vdw_pivot)[-1]

## Perform hierarchical clustering
rowclus <- hclust(dist( data_vdw_pivot_mat ))    #cluster the rows
colclus <- hclust(dist( t(data_vdw_pivot_mat) )) #cluster the columns

# bring the data.frame into a from easily usable by ggplot
hm <- hmReady(data_vdw_pivot_mat, colclus=colclus, rowclus=rowclus)
```

#### Render Cluster Plot

```{r}
# plot the heatmap
hmplot <- ggplot() + 
  geom_tile(data=hm, aes(x=x, y=y, fill=value)) +
  # scale_fill_gradientn(colors=hmGradient()) + 
  scale_fill_distiller(palette = "Spectral", direction = -1) +
  geom_dendro(colclus, ylim=c(165, 167)) +
  geom_dendro(rowclus, xlim=c(11.5, 13), pointing="side") +
  labs(y = "Antigen",
       x = 'Antibody',
       fill = "Mean\nvan der Waals\nEnergy") +
  theme_hm() +
  theme(axis.title=element_blank(),
        axis.text.y = element_text(size=5),
        legend.title = element_text(size=8),
        legend.text = element_text(size=8),
        legend.position = c(0.65, 0.95),
        legend.direction = "horizontal"
        # legend.position = "none"
        )
  
  
print(hmplot)
```

```{r}
ggsave("../../figures/dendro_vdw_grid.pdf", width = 5.5, height = 11, units = "in")
```



## Scatterplots

### General Plot Function

```{r}
make_h5_scatter_by_order <- function(y, y_lab){
  
  plot <- ggplot(data %>% filter(#antigen_collection_year >= 2000,
                                 antigen_host_order %in% c("Anseriformes", "Galliformes", "Primates")
  ),
  aes_string(
    x = "antigen_collection_year",
    y = y,
    group = "antigen_host_order",
    color = "antigen_host_order",
    alpha = 0.35
  )) + 
    geom_point() +
    geom_smooth(method = lm,
                se = TRUE,
                col='black',
                linetype="dashed",
                linewidth=1,
                # fullrange=TRUE
    ) +
    stat_cor(method = "spearman",
             color = "black",
             label.x = 2000,
             label.y = min(data[[y]])
    ) +
    # xlim(2000, 2024) + 
    scale_x_continuous(breaks=c(2000,2005,2010,2015,2020,2024), limits = c(2000, 2024)) +
    scale_color_manual(values = c("#005035", "#A49665", "#802F2D")) + ## UNCC Colors
    facet_wrap(~ antigen_host_order, ncol = 3) +
    labs(y = y_lab,
         x = 'Collection Year',
         color = "Host Order") +
    theme_linedraw() +
    # theme_minimal() +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
          line = element_line(colour = "grey"),
          axis.line = element_line(color = "grey"),
          panel.grid.minor = element_blank(),
          panel.grid.major = element_line(color = "grey"),
          legend.position = "none"
    )
  
  return(plot)
}

```

### Make Individual Score Plots

```{r}
## van der Waals Energy
scatter_vdw_by_year <- make_h5_scatter_by_order(y = "vdw_mean", y_lab = "Mean van der Waals Energy" )

## Electrostatic Energy
scatter_elec_by_year <- make_h5_scatter_by_order(y = "elec_mean", y_lab = "Mean Electrostatic Energy")

## Desolvation Energy
scatter_desolv_by_year <- make_h5_scatter_by_order(y = "desolv_mean", y_lab = "Mean Desolvation Energy")

## Buried Surface Area
scatter_bsa_by_year <- make_h5_scatter_by_order(y = "bsa_mean", y_lab = "Mean Buried Surface Area")

## HADDOCK Score
scatter_haddock_by_year <- make_h5_scatter_by_order(y = "haddock_score_mean", y_lab = "Mean HADDOCK Score")

## Total Score
scatter_total_by_year <- make_h5_scatter_by_order(y = "total_mean", y_lab = "Mean Total Energy")
```

### Place on single plot

```{r}
scatter_by_year_grid = ggarrange(scatter_vdw_by_year,
                                 scatter_elec_by_year,
                                 scatter_desolv_by_year,
                                 scatter_bsa_by_year,
                                 scatter_haddock_by_year,
                                 scatter_total_by_year,
                                 labels = c("A.", "B.", "C.", "D.", "E.", "F."),
                                 ncol = 2, nrow = 3)

scatter_by_year_grid
```


```{r}
ggsave("../../figures/scatter_by_year_grid.pdf", width = 11, height = 8.5, units = "in")
```


## Make General Statistics about Full Antigen Metadata

## Load in Data
```{r}
full_antigen_metadata <- read_excel("../../Experiments.xlsx", sheet = "Full Antigen Metadata")

## Filter out lab-derived isolates
full_antigen_metadata_filtered <- full_antigen_metadata %>% 
  filter(!antigen_host_name %in% c("Laboratory derived"))
```


## Make Treemap by Country

```{r}
library(treemapify)

full_antigen_metadata_filtered_country_summary <- full_antigen_metadata_filtered %>% 
  select(antigen_collection_location_continent, antigen_collection_location_country) %>%
  add_count(antigen_collection_location_continent, antigen_collection_location_country, name = "isolate_count") %>% 
  unique()


ggplot(full_antigen_metadata_filtered_country_summary,
       aes(area = isolate_count,
           fill = antigen_collection_location_country,
           label = antigen_collection_location_country,
           subgroup = antigen_collection_location_continent
           )) +
  geom_treemap() +
  geom_treemap_subgroup_border() +
  geom_treemap_subgroup_text(place = "centre", grow = T, alpha = 0.5, colour =
                             "black", fontface = "italic", min.size = 0) +
  geom_treemap_text(colour = "white", place = "topleft", reflow = T)

```